# QA MCP Server Tests

Комплексна система тестування для QA MCP Server, включаюча юніт-тести з моками та інтеграційні тести з реальними підключеннями.

## Структура тестів

```text
tests/
├── conftest.py                    # Pytest конфігурація та фікстури
├── unit/                          # Юніт-тести з моками
│   ├── test_mcp_tools.py         # Тести для mcp_tools.py
│   └── test_mcp_server.py        # Тести для mcp_server.py
├── integration/                   # Інтеграційні тести
│   └── test_mcp_integration.py   # Тести з реальними підключеннями
├── scenarios/                     # Тестові сценарії
│   └── test_search_scenarios.py  # Сценарії на основі реальних тестів
├── requirements-test.txt          # Залежності для тестування
└── README.md                      # Ця документація
```

## Типи тестів

### 1. Юніт-тести (`unit/`)

**Призначення:** Тестують окремі функції з використанням моків.

**Особливості:**
- Використовують моки для всіх зовнішніх залежностей
- Швидкі в виконанні
- Не потребують реальних сервісів
- Тестують логіку та валідацію параметрів

**Покриття:**
- `qa_search_documents` - пошук документів
- `qa_search_testcases` - семантичний пошук тест-кейсів
- `qa_search_testcases_text` - текстовий пошук тест-кейсів
- `qa_list_features` - список функціональностей
- `qa_docs_by_feature` - документи за функціональністю
- `qa_health` - перевірка здоров'я системи
- `qa_get_sections` - отримання секцій
- `qa_get_checklists` - отримання чеклістів
- `qa_get_testcases` - отримання тест-кейсів
- `qa_get_configs` - отримання конфігурацій
- `qa_get_statistics` - статистика
- `qa_get_full_structure` - повна структура

### 2. Інтеграційні тести (`integration/`)

**Призначення:** Тестують реальні підключення до MCP сервера.

**Особливості:**
- Використовують реальний MCP сервер
- Тестують JSON-RPC та HTTP API
- Перевіряють повний цикл запит-відповідь
- Потребують запущеного сервера

**Покриття:**
- Health check через MCP та HTTP
- Пошук документів через різні методи
- Отримання даних через всі інструменти
- Обробка помилок та валідація
- Тести продуктивності
- End-to-end сценарії

### 3. Тестові сценарії (`scenarios/`)

**Призначення:** Реплікують реальні тестові сценарії, які були виконані.

**Особливості:**
- Базовані на фактичних тестах
- Перевіряють конкретні випадки використання
- Включають порівняння до/після змін
- Тестують українську та англійську мови

**Сценарії:**
- Пошук українською мовою
- Пошук англійською мовою
- Семантичний пошук
- Текстовий пошук
- Фільтрація за функціональністю
- Перевірка здоров'я після рестарту
- Обробка помилок
- Тести продуктивності
- Повний робочий процес

## Запуск тестів

### Встановлення залежностей

```bash
# Встановити тестові залежності
pip install -r tests/requirements-test.txt
```

### Запуск через скрипт

```bash
# Юніт-тести
./scripts/run_tests.sh -t unit

# Інтеграційні тести (потребує запущеного сервера)
./scripts/run_tests.sh -t integration

# Всі тести
./scripts/run_tests.sh -t all

# З покриттям коду
./scripts/run_tests.sh -t all -c

# Виключити повільні тести
./scripts/run_tests.sh -m "not slow"

# Паралельне виконання
./scripts/run_tests.sh -t all -p
```

### Запуск через pytest

```bash
# Юніт-тести
pytest tests/unit/ -v

# Інтеграційні тести
pytest tests/integration/ -v

# Тестові сценарії
pytest tests/scenarios/ -v

# З маркерами
pytest -m unit -v
pytest -m integration -v
pytest -m scenario -v
pytest -m "not slow" -v

# З покриттям
pytest --cov=app --cov-report=html
```

## Маркери тестів

- `unit` - Юніт-тести з моками
- `integration` - Інтеграційні тести з реальними підключеннями
- `scenario` - Тестові сценарії
- `slow` - Повільні тести (потребують більше часу)

## Конфігурація

### pytest.ini
Основна конфігурація pytest з маркерами, налаштуваннями виводу та async підтримкою.

### conftest.py
Містить:
- Фікстури для тестів
- Моки для зовнішніх залежностей
- Тестові дані
- Налаштування середовища

## Тестові дані

### Моки
- `mock_qa_repo` - Мок репозиторію QA
- `mock_openai_embedder` - Мок OpenAI embedder
- `mock_vector_repo` - Мок векторного репозиторію
- `mock_mcp_context` - Мок MCP контексту

### Тестові дані
- `sample_qa_data` - Приклади QA даних
- `sample_search_results` - Приклади результатів пошуку
- `sample_health_response` - Приклад відповіді health check

## Покриття коду

Для генерації звіту про покриття коду:

```bash
# Встановити pytest-cov
pip install pytest-cov

# Запустити з покриттям
pytest --cov=app --cov-report=html --cov-report=term-missing

# Переглянути звіт
open htmlcov/index.html
```

## Налагодження тестів

### Детальний вивід
```bash
pytest -v -s --tb=long
```

### Запуск конкретного тесту
```bash
pytest tests/unit/test_mcp_tools.py::TestQASearchDocuments::test_successful_search -v
```

### Логування
```bash
pytest --log-cli-level=DEBUG
```

## CI/CD Integration

### GitHub Actions
```yaml
- name: Run Unit Tests
  run: ./scripts/run_tests.sh -t unit -c

- name: Run Integration Tests
  run: ./scripts/run_tests.sh -t integration
  env:
    MCP_SERVER_URL: http://localhost:3000
```

### Docker
```bash
# Запуск тестів в Docker
docker-compose -f docker-compose.test.yml up --abort-on-container-exit
```

## Найкращі практики

### Написання тестів
1. **Один тест - одна перевірка** - кожен тест повинен перевіряти одну конкретну функціональність
2. **Описові назви** - назви тестів повинні чітко описувати що тестується
3. **AAA Pattern** - Arrange, Act, Assert
4. **Незалежність** - тести не повинні залежати один від одного
5. **Детермінізм** - тести повинні давати однаковий результат при кожному запуску

### Моки
1. **Мокайте зовнішні залежності** - база даних, API, файлова система
2. **Не мокайте тестуємий код** - мокайте тільки залежності
3. **Перевіряйте виклики моків** - assert_called_with, assert_called_once
4. **Використовуйте реальні дані** - моки повинні повертати реалістичні дані

### Інтеграційні тести
1. **Тестуйте реальні сценарії** - використовуйте тести, які відповідають реальному використанню
2. **Очищайте після тестів** - видаляйте тестові дані
3. **Використовуйте тестову базу** - не тестуйте на продакшн даних
4. **Тестуйте помилки** - перевіряйте обробку помилок

## Troubleshooting

### Часті проблеми

1. **Тести не знаходять модулі**
   ```bash
   export PYTHONPATH="${PYTHONPATH}:$(pwd)"
   ```

2. **Проблеми з async тестами**
   ```bash
   pip install pytest-asyncio
   ```

3. **Моки не працюють**
   - Перевірте шляхи імпорту
   - Використовуйте `patch` правильно
   - Перевірте порядок імпортів

4. **Інтеграційні тести падають**
   - Перевірте що сервер запущений
   - Перевірте URL та порти
   - Перевірте доступність сервісів

### Логи та налагодження

```bash
# Детальні логи
pytest --log-cli-level=DEBUG -s

# Збереження логів
pytest --log-file=test.log --log-file-level=DEBUG

# Перевірка конфігурації
pytest --collect-only
```

## Оновлення тестів

При додаванні нових функцій:

1. **Додайте юніт-тести** для нової функціональності
2. **Додайте інтеграційні тести** якщо потрібно
3. **Оновіть тестові сценарії** якщо зміни впливають на робочі процеси
4. **Оновіть документацію** якщо зміни впливають на API

## Контрибуція

1. **Напишіть тести** для нової функціональності
2. **Переконайтеся що всі тести проходять**
3. **Додайте тести для edge cases**
4. **Оновіть документацію** якщо потрібно
